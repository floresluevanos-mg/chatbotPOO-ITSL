<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TutorPOO ‚Äî Chatbot Educativo ¬∑ Clases y M√©todos</title>
<style>
/* =====================================================================
   VARIABLES Y RESET
   ===================================================================== */
:root {
  --bg:            #f0f4ff;
  --surface:       #ffffff;
  --surface2:      #f7f9ff;
  --primary:       #3a5bdb;
  --primary-light: #6681f5;
  --primary-dark:  #2640b0;
  --accent:        #ff6b35;
  --accent2:       #00c896;
  --text:          #1a1f36;
  --text-soft:     #5a6380;
  --text-muted:    #9098b5;
  --border:        #dde3f8;
  --shadow:        0 4px 24px rgba(58,91,219,.10);
  --shadow-lg:     0 8px 40px rgba(58,91,219,.18);
  --radius:        18px;
  --radius-sm:     10px;
  --font-display:  'Georgia','Times New Roman',serif;
  --font-body:     'Segoe UI',system-ui,-apple-system,sans-serif;
  --font-code:     'Consolas','Courier New',monospace;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;scroll-behavior:smooth}
body{
  font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh;
  background-image:radial-gradient(circle at 20% 10%,rgba(102,129,245,.12) 0%,transparent 50%),
    radial-gradient(circle at 80% 90%,rgba(0,200,150,.08) 0%,transparent 50%);
}
/* HEADER */
.app-header{
  background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;height:64px;
  display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;
  box-shadow:0 2px 12px rgba(58,91,219,.08);
}
.header-brand{display:flex;align-items:center;gap:12px}
.header-logo{
  width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--primary-light));
  border-radius:12px;display:flex;align-items:center;justify-content:center;
  font-size:20px;box-shadow:0 4px 12px rgba(58,91,219,.25);
}
.header-title{font-family:var(--font-display);font-size:1.25rem;font-weight:700;color:var(--primary);letter-spacing:-.02em}
.header-subtitle{font-size:.7rem;color:var(--text-muted);display:block;margin-top:1px}
.header-teacher{font-size:.78rem;color:var(--text-soft);text-align:right;line-height:1.4}
.header-teacher strong{color:var(--primary);font-size:.82rem}
/* PROGRESO */
.progress-bar-wrap{background:var(--surface);border-bottom:1px solid var(--border);padding:8px 24px 10px}
.progress-label{display:flex;justify-content:space-between;font-size:.72rem;color:var(--text-muted);margin-bottom:5px}
.progress-track{background:var(--border);border-radius:999px;height:7px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-light),var(--accent2));border-radius:999px;transition:width .6s cubic-bezier(.4,0,.2,1);width:0%}
.progress-steps{display:flex;gap:6px;margin-top:6px}
.step-dot{height:4px;flex:1;border-radius:99px;background:var(--border);transition:background .4s}
.step-dot.active{background:var(--primary-light)}.step-dot.done{background:var(--accent2)}
/* LAYOUT */
.app-layout{max-width:900px;margin:0 auto;padding:24px 16px;display:flex;flex-direction:column;gap:20px}
/* SCREENS */
.screen{display:none;animation:fadeIn .4s ease}.screen.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
/* REGISTRO */
.register-card{
  background:var(--surface);border-radius:var(--radius);padding:40px 36px;
  box-shadow:var(--shadow-lg);max-width:520px;margin:0 auto;border:1px solid var(--border);
}
.register-icon{font-size:3rem;text-align:center;margin-bottom:16px}
.register-title{font-family:var(--font-display);font-size:1.7rem;color:var(--primary);text-align:center;margin-bottom:6px}
.register-desc{text-align:center;color:var(--text-soft);font-size:.92rem;margin-bottom:28px;line-height:1.6}
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:.82rem;font-weight:600;color:var(--text);margin-bottom:7px;letter-spacing:.01em}
.form-group input{
  width:100%;padding:11px 16px;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  font-family:var(--font-body);font-size:.95rem;color:var(--text);background:var(--surface2);
  transition:border-color .2s,box-shadow .2s;outline:none;
}
.form-group input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(58,91,219,.12);background:#fff}
/* BOTONES */
.btn-primary{
  width:100%;padding:13px;background:linear-gradient(135deg,var(--primary),var(--primary-light));
  color:#fff;border:none;border-radius:var(--radius-sm);font-family:var(--font-body);font-size:1rem;
  font-weight:700;cursor:pointer;letter-spacing:.02em;transition:transform .15s,box-shadow .2s;
  box-shadow:0 4px 16px rgba(58,91,219,.3);
}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(58,91,219,.4)}
.btn-download{
  padding:11px 22px;background:linear-gradient(135deg,var(--accent2),#00a87c);color:#fff;border:none;
  border-radius:var(--radius-sm);font-family:var(--font-body);font-size:.9rem;font-weight:700;cursor:pointer;
  transition:transform .15s,box-shadow .2s;box-shadow:0 3px 12px rgba(0,200,150,.3);
}
.btn-download:hover{transform:translateY(-2px);box-shadow:0 5px 18px rgba(0,200,150,.45)}
.btn-danger{
  padding:11px 22px;background:#fff;color:#e53e3e;border:1.5px solid #fca5a5;
  border-radius:var(--radius-sm);font-family:var(--font-body);font-size:.9rem;font-weight:600;
  cursor:pointer;transition:background .2s,border-color .2s;
}
.btn-danger:hover{background:#fff5f5;border-color:#e53e3e}
/* CHAT */
.chat-container{
  background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow-lg);border:1px solid var(--border);
  display:flex;flex-direction:column;height:calc(100vh - 200px);min-height:500px;max-height:680px;overflow:hidden;
}
.chat-header{padding:16px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;background:linear-gradient(135deg,#f0f4ff,#f7f9ff)}
.bot-avatar{width:46px;height:46px;background:linear-gradient(135deg,var(--primary),var(--primary-light));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 3px 10px rgba(58,91,219,.25);flex-shrink:0}
.bot-info h3{font-size:1rem;font-weight:700;color:var(--primary)}.bot-info p{font-size:.75rem;color:var(--text-muted)}
.chat-topic-badge{margin-left:auto;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;font-size:.7rem;font-weight:700;padding:4px 12px;border-radius:99px;letter-spacing:.04em}
.chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:14px;scroll-behavior:smooth}
.chat-messages::-webkit-scrollbar{width:6px}.chat-messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px}
.msg{display:flex;gap:10px;max-width:85%;animation:msgIn .3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg.bot{align-self:flex-start}.msg.user{align-self:flex-end;flex-direction:row-reverse}
.msg-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;margin-top:2px}
.msg.bot .msg-avatar{background:linear-gradient(135deg,var(--primary),var(--primary-light))}
.msg.user .msg-avatar{background:linear-gradient(135deg,var(--accent),#ff9f70)}
.msg-bubble{padding:11px 16px;border-radius:16px;font-size:.93rem;line-height:1.6;word-break:break-word}
.msg.bot .msg-bubble{background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:4px;color:var(--text)}
.msg.user .msg-bubble{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border-bottom-right-radius:4px}
.msg-bubble code{font-family:var(--font-code);background:rgba(58,91,219,.1);padding:2px 6px;border-radius:4px;font-size:.85rem;color:var(--primary)}
.msg.user .msg-bubble code{background:rgba(255,255,255,.2);color:#fff}
.msg-bubble pre{background:#1a1f36;color:#c9d1f5;border-radius:10px;padding:14px 16px;font-family:var(--font-code);font-size:.8rem;overflow-x:auto;margin:10px 0 4px;line-height:1.7;border:1px solid #2d3468}
.msg-bubble pre .kw{color:#7c98ff}.msg-bubble pre .cl{color:#ffd080}.msg-bubble pre .st{color:#80ffb4}.msg-bubble pre .cm{color:#6b7ab5;font-style:italic}.msg-bubble pre .nm{color:#ff9f70}
.quick-replies{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.qr-btn{padding:7px 16px;background:#fff;border:1.5px solid var(--primary);color:var(--primary);border-radius:99px;font-size:.84rem;font-weight:600;cursor:pointer;transition:all .18s;font-family:var(--font-body)}
.qr-btn:hover{background:var(--primary);color:#fff}
.chat-input-area{padding:14px 18px;border-top:1px solid var(--border);display:flex;gap:10px;align-items:center;background:var(--surface2)}
.chat-input{flex:1;padding:10px 16px;border:1.5px solid var(--border);border-radius:99px;font-family:var(--font-body);font-size:.93rem;outline:none;background:#fff;transition:border-color .2s,box-shadow .2s}
.chat-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(58,91,219,.1)}
.chat-send-btn{width:42px;height:42px;background:linear-gradient(135deg,var(--primary),var(--primary-light));border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:transform .15s,box-shadow .2s;box-shadow:0 3px 12px rgba(58,91,219,.3);flex-shrink:0}
.chat-send-btn:hover{transform:scale(1.1)}
.typing-indicator{display:flex;gap:5px;padding:12px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:16px;border-bottom-left-radius:4px;width:fit-content;align-self:flex-start}
.typing-dot{width:7px;height:7px;background:var(--primary-light);border-radius:50%;animation:bounce 1.2s infinite}
.typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,60%,100%{transform:translateY(0);opacity:.5}30%{transform:translateY(-6px);opacity:1}}
.topic-chip{display:inline-block;background:rgba(58,91,219,.1);color:var(--primary);font-size:.73rem;font-weight:700;padding:3px 10px;border-radius:99px;margin:2px 2px 6px;letter-spacing:.03em}
/* QUIZ */
.quiz-card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow-lg);border:1px solid var(--border);overflow:hidden}
.quiz-header{background:linear-gradient(135deg,var(--primary),var(--primary-light));padding:22px 28px;color:#fff}
.quiz-header h2{font-family:var(--font-display);font-size:1.4rem;margin-bottom:4px}
.quiz-header p{font-size:.85rem;opacity:.85}
.quiz-meta{display:flex;gap:20px;margin-top:12px;font-size:.8rem;opacity:.9}
.quiz-body{padding:28px}
.question-number{font-size:.75rem;font-weight:700;color:var(--text-muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:10px}
.question-text{font-size:1.08rem;font-weight:600;color:var(--text);margin-bottom:20px;line-height:1.5}
.quiz-options{display:flex;flex-direction:column;gap:10px}
.quiz-option{padding:13px 18px;border:2px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;font-size:.93rem;font-family:var(--font-body);background:var(--surface2);text-align:left;transition:all .18s;display:flex;align-items:center;gap:12px}
.quiz-option:hover:not(:disabled){border-color:var(--primary);background:rgba(58,91,219,.06);transform:translateX(4px)}
.quiz-option.correct{border-color:var(--accent2);background:rgba(0,200,150,.1);color:#007a5e;font-weight:600}
.quiz-option.incorrect{border-color:#ff4d6d;background:rgba(255,77,109,.08);color:#c0002a}
.quiz-option:disabled{cursor:not-allowed}
.option-letter{width:26px;height:26px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:.78rem;font-weight:700;flex-shrink:0;transition:background .18s}
.quiz-option:hover:not(:disabled) .option-letter{background:var(--primary);color:#fff}
.quiz-option.correct .option-letter{background:var(--accent2);color:#fff}
.quiz-option.incorrect .option-letter{background:#ff4d6d;color:#fff}
.quiz-feedback{margin-top:16px;padding:12px 16px;border-radius:var(--radius-sm);font-size:.88rem;font-weight:600;display:none;animation:fadeIn .3s ease}
.quiz-feedback.show{display:flex;gap:10px;align-items:flex-start}
.quiz-feedback.correct-fb{background:rgba(0,200,150,.12);color:#007a5e;border:1px solid rgba(0,200,150,.3)}
.quiz-feedback.wrong-fb{background:rgba(255,77,109,.08);color:#c0002a;border:1px solid rgba(255,77,109,.2)}
.quiz-nav{display:flex;justify-content:space-between;align-items:center;margin-top:22px;padding-top:18px;border-top:1px solid var(--border)}
.score-badge{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;padding:6px 16px;border-radius:99px;font-size:.82rem;font-weight:700}
.quiz-result{text-align:center;padding:40px 28px}
.result-score-circle{width:130px;height:130px;border-radius:50%;margin:0 auto 20px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:conic-gradient(var(--primary-light) 0%,var(--accent2) var(--pct,0%),var(--border) var(--pct,0%));padding:8px}
.result-score-inner{width:110px;height:110px;border-radius:50%;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center}
.result-score-num{font-family:var(--font-display);font-size:2.2rem;font-weight:700;color:var(--primary);line-height:1}
.result-score-label{font-size:.72rem;color:var(--text-muted)}
.result-title{font-family:var(--font-display);font-size:1.6rem;color:var(--primary);margin-bottom:8px}
.result-msg{color:var(--text-soft);font-size:.95rem;margin-bottom:24px;line-height:1.5}
/* ENCUESTA */
.survey-card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow-lg);border:1px solid var(--border);overflow:hidden}
.survey-header{background:linear-gradient(135deg,#2640b0,var(--primary));padding:22px 28px;color:#fff}
.survey-header h2{font-family:var(--font-display);font-size:1.4rem;margin-bottom:4px}
.survey-header p{font-size:.85rem;opacity:.85}
.survey-body{padding:28px;display:flex;flex-direction:column;gap:22px}
.survey-q{font-size:.93rem;color:var(--text);margin-bottom:10px;line-height:1.5}
.survey-q strong{color:var(--primary)}
.likert-labels{display:flex;justify-content:space-between;font-size:.68rem;color:var(--text-muted);margin-bottom:5px}
.likert-scale{display:flex;gap:8px}
.likert-btn{flex:1;padding:8px 4px;border:2px solid var(--border);border-radius:var(--radius-sm);background:var(--surface2);cursor:pointer;font-size:.88rem;font-weight:700;color:var(--text-soft);text-align:center;transition:all .18s;font-family:var(--font-body)}
.likert-btn:hover{border-color:var(--primary);color:var(--primary)}
.likert-btn.selected{background:linear-gradient(135deg,var(--primary),var(--primary-light));border-color:var(--primary);color:#fff;transform:scale(1.05);box-shadow:0 3px 10px rgba(58,91,219,.3)}
.survey-footer{padding:20px 28px;border-top:1px solid var(--border);background:var(--surface2);display:flex;flex-direction:column;gap:14px}
/* FINAL */
.final-card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow-lg);border:1px solid var(--border);padding:40px 36px;text-align:center;max-width:600px;margin:0 auto}
.final-trophy{font-size:4rem;margin-bottom:16px}
.final-title{font-family:var(--font-display);font-size:2rem;color:var(--primary);margin-bottom:8px}
.final-subtitle{color:var(--text-soft);margin-bottom:28px;line-height:1.6}
.final-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:28px}
.final-stat{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px}
.final-stat-num{font-family:var(--font-display);font-size:2rem;font-weight:700;color:var(--primary)}
.final-stat-label{font-size:.78rem;color:var(--text-muted);margin-top:3px}
.final-cert{background:linear-gradient(135deg,#f0f4ff,#f7fff9);border:2px dashed var(--primary-light);border-radius:var(--radius-sm);padding:18px;margin-bottom:24px;font-size:.88rem;color:var(--text-soft);line-height:1.7}
.final-cert strong{color:var(--primary)}
/* MISC */
.divider{height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:6px 0}
.error-msg{color:#e53e3e;font-size:.82rem;margin-top:5px}
/* BOT√ìN FLOTANTE */
#admin-fab{
  position:fixed;bottom:22px;right:22px;width:44px;height:44px;border-radius:50%;
  background:rgba(38,64,176,.1);border:1.5px solid rgba(58,91,219,.2);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:18px;color:rgba(58,91,219,.35);
  transition:all .25s;z-index:200;
}
#admin-fab:hover{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 4px 16px rgba(58,91,219,.4)}
/* MODALES */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(10,15,40,.6);backdrop-filter:blur(5px);z-index:300;align-items:center;justify-content:center;padding:16px}
.modal-overlay.open{display:flex;animation:fadeIn .25s ease}
.modal-box{background:var(--surface);border-radius:var(--radius);padding:34px 30px;width:100%;max-width:400px;box-shadow:var(--shadow-lg);border:1px solid var(--border);position:relative}
.modal-close{position:absolute;top:14px;right:16px;background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--text-muted);transition:color .2s}
.modal-close:hover{color:var(--text)}
.modal-icon{font-size:2.4rem;text-align:center;margin-bottom:10px}
.modal-title{font-family:var(--font-display);font-size:1.25rem;color:var(--primary);text-align:center;margin-bottom:4px}
.modal-desc{font-size:.82rem;color:var(--text-muted);text-align:center;margin-bottom:22px;line-height:1.5}
.modal-input{width:100%;padding:11px 16px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font-body);font-size:.95rem;outline:none;background:var(--surface2);transition:border-color .2s,box-shadow .2s;margin-bottom:12px}
.modal-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(58,91,219,.1)}
.modal-error{color:#e53e3e;font-size:.8rem;margin-bottom:10px;display:none;text-align:center}
/* PANEL ADMIN */
.admin-panel{background:var(--surface);border-radius:var(--radius);padding:30px 28px;width:100%;max-width:860px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);border:1px solid var(--border)}
.admin-panel::-webkit-scrollbar{width:6px}.admin-panel::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px}
.admin-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.admin-title{font-family:var(--font-display);font-size:1.3rem;color:var(--primary)}
.admin-subtitle{font-size:.78rem;color:var(--text-muted);margin-top:3px}
.admin-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:22px}
.admin-stat{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;text-align:center}
.admin-stat-num{font-family:var(--font-display);font-size:1.8rem;font-weight:700;color:var(--primary)}
.admin-stat-label{font-size:.72rem;color:var(--text-muted);margin-top:2px}
.admin-table-wrap{overflow-x:auto;margin-bottom:20px;border-radius:var(--radius-sm);border:1px solid var(--border)}
.admin-table{width:100%;border-collapse:collapse;font-size:.8rem}
.admin-table th{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;padding:10px 12px;text-align:left;font-weight:700;white-space:nowrap;font-size:.74rem;letter-spacing:.03em}
.admin-table td{padding:9px 12px;border-bottom:1px solid var(--border);color:var(--text);white-space:nowrap}
.admin-table tr:last-child td{border-bottom:none}
.admin-table tr:nth-child(even) td{background:var(--surface2)}
.admin-table tr:hover td{background:rgba(58,91,219,.04)}
.admin-actions{display:flex;gap:10px;flex-wrap:wrap}
.admin-empty{text-align:center;padding:32px;color:var(--text-muted);font-size:.9rem}
/* RESPONSIVE */
@media(max-width:600px){
  .app-header{padding:0 14px}.header-teacher{display:none}
  .register-card{padding:26px 20px}.final-grid{grid-template-columns:1fr}
  .chat-container{height:calc(100vh - 180px)}.app-layout{padding:14px 10px}
  .quiz-body,.survey-body{padding:20px}.admin-stats{grid-template-columns:1fr 1fr}
  .admin-panel{padding:20px 14px}
}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
<header class="app-header">
  <div class="header-brand">
    <div class="header-logo">üéì</div>
    <div>
      <div class="header-title">TutorPOO</div>
      <span class="header-subtitle">Programaci√≥n Orientada a Objetos ¬∑ Nivel Superior</span>
    </div>
  </div>
  <div class="header-teacher">
    <strong>Dra. Mar√≠a Guadalupe Flores Lu√©vanos</strong><br>Docente responsable
  </div>
</header>

<!-- ‚îÄ‚îÄ BARRA DE PROGRESO ‚îÄ‚îÄ -->
<div class="progress-bar-wrap">
  <div class="progress-label">
    <span id="progressLabelLeft">Inicio</span>
    <span id="progressLabelRight">0%</span>
  </div>
  <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
  <div class="progress-steps" id="progressSteps"></div>
</div>

<main class="app-layout">

  <!-- PANTALLA 1: REGISTRO -->
  <section class="screen active" id="screen-register">
    <div class="register-card">
      <div class="register-icon">üìã</div>
      <h1 class="register-title">Bienvenido/a al Tutor Virtual</h1>
      <p class="register-desc">
        Ingresa tus datos para comenzar.<br>
        M√≥dulo: <strong>Introducci√≥n a Clases y M√©todos en POO</strong>.
      </p>
      <div class="form-group">
        <label>üë§ Nombre completo</label>
        <input type="text" id="inp-nombre" placeholder="Ej. Ana Mart√≠nez L√≥pez">
        <div class="error-msg" id="err-nombre"></div>
      </div>
      <div class="form-group">
        <label>üî¢ N√∫mero de control</label>
        <input type="text" id="inp-control" placeholder="Ej. 22100001">
        <div class="error-msg" id="err-control"></div>
      </div>
      <div class="form-group">
        <label>üè´ Grupo</label>
        <input type="text" id="inp-grupo" placeholder="Ej. 3A-ISC">
        <div class="error-msg" id="err-grupo"></div>
      </div>
      <button class="btn-primary" onclick="startChat()">üöÄ Comenzar el aprendizaje</button>
    </div>
  </section>

  <!-- PANTALLA 2: CHATBOT -->
  <section class="screen" id="screen-chat">
    <div class="chat-container">
      <div class="chat-header">
        <div class="bot-avatar">ü§ñ</div>
        <div class="bot-info">
          <h3>ProfeBot ‚Äî Asistente POO</h3>
          <p>Respondiendo en tiempo real ¬∑ Modo tutor activo</p>
        </div>
        <div class="chat-topic-badge">POO ¬∑ C#</div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" class="chat-input" id="chatInput"
               placeholder="Escribe tu respuesta‚Ä¶"
               onkeydown="if(event.key==='Enter')sendMessage()">
        <button class="chat-send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </section>

  <!-- PANTALLA 3: QUIZ -->
  <section class="screen" id="screen-quiz">
    <div class="quiz-card">
      <div class="quiz-header">
        <h2>üß† Quiz Gamificado ‚Äî POO</h2>
        <p>Responde las preguntas sobre lo aprendido. ¬°Cada punto cuenta!</p>
        <div class="quiz-meta">
          <span>‚ùì <span id="qNumLabel">Pregunta 1</span> de 10</span>
          <span>‚≠ê Puntos: <span id="qScoreLabel">0</span></span>
        </div>
      </div>
      <div class="quiz-body" id="quizBody"></div>
    </div>
  </section>

  <!-- PANTALLA 4: ENCUESTA BUS-11 -->
  <section class="screen" id="screen-survey">
    <div class="survey-card">
      <div class="survey-header">
        <h2>üìä Escala de Usabilidad ‚Äî BUS-11</h2>
        <p>Tu opini√≥n mejora esta herramienta. Responde con sinceridad.</p>
      </div>
      <div class="survey-body" id="surveyBody"></div>
      <div class="survey-footer">
        <div id="surveyError" class="error-msg" style="display:none">‚ö†Ô∏è Responde todas las preguntas antes de continuar.</div>
        <button class="btn-primary" onclick="submitSurvey()">üì§ Enviar encuesta y ver resultados</button>
      </div>
    </div>
  </section>

  <!-- PANTALLA 5: RESULTADO FINAL -->
  <section class="screen" id="screen-final">
    <div class="final-card">
      <div class="final-trophy">üèÜ</div>
      <h2 class="final-title">¬°Sesi√≥n completada!</h2>
      <p class="final-subtitle" id="finalSubtitle"></p>
      <div class="final-cert" id="finalCert"></div>
      <div class="final-grid" id="finalGrid"></div>
      <p style="font-size:.82rem;color:var(--text-muted);line-height:1.6">
        Docente: <strong>Dra. Mar√≠a Guadalupe Flores Lu√©vanos</strong><br>
        Materia: Programaci√≥n Orientada a Objetos ¬∑ TutorPOO v2.0
      </p>
    </div>
  </section>

</main>

<!-- BOT√ìN FLOTANTE AUTOR (discreto) -->
<button id="admin-fab" title="Acceso de autor" onclick="openAdminLogin()">üîë</button>

<!-- MODAL: LOGIN -->
<div class="modal-overlay" id="modal-login">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('modal-login')">‚úï</button>
    <div class="modal-icon">üîê</div>
    <div class="modal-title">Acceso de Autor</div>
    <div class="modal-desc">Ingresa la contrase√±a para ver y descargar los resultados acumulados de los alumnos.</div>
    <input type="password" class="modal-input" id="adminPassInput"
           placeholder="Contrase√±a de autor"
           onkeydown="if(event.key==='Enter')checkAdminPass()">
    <div class="modal-error" id="adminPassError">‚ö†Ô∏è Contrase√±a incorrecta. Int√©ntalo de nuevo.</div>
    <button class="btn-primary" onclick="checkAdminPass()">üîì Ingresar al panel</button>
  </div>
</div>

<!-- MODAL: PANEL ADMIN -->
<div class="modal-overlay" id="modal-admin">
  <div class="admin-panel">
    <div class="admin-header">
      <div>
        <div class="admin-title">üìä Panel de Autor ‚Äî TutorPOO</div>
        <div class="admin-subtitle">Dra. Mar√≠a Guadalupe Flores Lu√©vanos ¬∑ Resultados acumulados de alumnos</div>
      </div>
      <button class="modal-close" style="position:relative;top:auto;right:auto;margin-left:16px" onclick="closeModal('modal-admin')">‚úï</button>
    </div>
    <div class="admin-stats" id="adminStats"></div>
    <div class="admin-table-wrap">
      <table class="admin-table" id="adminTable">
        <thead>
          <tr>
            <th>#</th><th>Nombre</th><th>No. Control</th><th>Grupo</th>
            <th>Quiz pts</th><th>Quiz %</th>
            <th>BUS-11 Total</th><th>BUS-11 Prom.</th><th>Usabilidad</th>
            <th>Fecha</th><th>Hora</th>
          </tr>
        </thead>
        <tbody id="adminTableBody"></tbody>
      </table>
      <div class="admin-empty" id="adminEmpty" style="display:none">üì≠ A√∫n no hay registros almacenados.</div>
    </div>
    <div class="admin-actions">
      <button class="btn-download" onclick="downloadCSV()">‚¨áÔ∏è Descargar CSV</button>
      <button class="btn-danger"   onclick="clearAllRecords()">üóëÔ∏è Borrar todos los registros</button>
    </div>
  </div>
</div>

<script>
/* =============================================================
   ESTADO GLOBAL
   ============================================================= */
const APP = {
  student:       { nombre:'', control:'', grupo:'' },
  chatStep:      0,
  quizIndex:     0,
  quizScore:     0,
  quizAnswered:  false,
  surveyAnswers: {}
};
const RECORDS_KEY = 'tutorpoo_records_v2';  // clave localStorage registros acumulados
const AUTHOR_PASS = 'chatbotITSL';          // contrase√±a del panel de autor

/* =============================================================
   PROGRESO Y NAVEGACI√ìN
   ============================================================= */
const SCREENS      = ['register','chat','quiz','survey','final'];
const STEP_LABELS  = ['Registro','Aprendizaje','Quiz','Encuesta','Resultados'];

function initProgressBar() {
  const wrap = document.getElementById('progressSteps');
  wrap.innerHTML = '';
  STEP_LABELS.forEach((_,i) => {
    const d = document.createElement('div');
    d.className = 'step-dot'; d.id = 'sdot-'+i;
    wrap.appendChild(d);
  });
  updateProgress(0);
}

function updateProgress(idx) {
  const pct = Math.round(idx / (STEP_LABELS.length-1) * 100);
  document.getElementById('progressFill').style.width = pct+'%';
  document.getElementById('progressLabelLeft').textContent  = STEP_LABELS[idx];
  document.getElementById('progressLabelRight').textContent = pct+'%';
  STEP_LABELS.forEach((_,i) => {
    document.getElementById('sdot-'+i).className =
      'step-dot'+(i<idx?' done':i===idx?' active':'');
  });
}

function goTo(name) {
  SCREENS.forEach(s => document.getElementById('screen-'+s).classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  updateProgress(SCREENS.indexOf(name));
  window.scrollTo(0,0);
}

/* =============================================================
   PANTALLA 1 ‚Äî REGISTRO
   ============================================================= */
function startChat() {
  let ok = true;
  ['nombre','control','grupo'].forEach(f => {
    const v = document.getElementById('inp-'+f).value.trim();
    document.getElementById('err-'+f).textContent = v ? '' : 'Campo obligatorio.';
    if (!v) ok = false;
    APP.student[f] = v;
  });
  if (!ok) return;
  localStorage.setItem('tutorpoo_student', JSON.stringify(APP.student));
  goTo('chat');
  initChat();
}

/* =============================================================
   PANTALLA 2 ‚Äî CHATBOT
   ============================================================= */
const CHAT_SCRIPT = [
  { type:'bot',
    text:()=>`¬°Hola, <strong>${APP.student.nombre}</strong>! üëã Bienvenido/a al Tutor Virtual de <strong>POO</strong>.<br><br>
    Hoy aprender√°s:<br><br>
    <span class="topic-chip">üì¶ Clases</span><span class="topic-chip">üîµ Objetos</span>
    <span class="topic-chip">‚öôÔ∏è Atributos</span><span class="topic-chip">üîß M√©todos</span>
    <span class="topic-chip">üèóÔ∏è Constructores</span><br><br>¬øListo/a para comenzar?`,
    replies:['¬°S√≠, empecemos! üöÄ','¬øC√≥mo funciona la sesi√≥n?']
  },
  { type:'bot',
    text:`<strong>¬øQu√© es una Clase?</strong><br><br>
    Una <em>clase</em> es un <strong>molde o plantilla</strong> que define la estructura y comportamiento de los objetos.<br><br>
    üìå Analog√≠a: el molde de galletas es la clase; cada galleta es un objeto.<br><br>En C#:`,
    code:`<span class="cm">// Declaraci√≥n de clase en C#</span>
<span class="kw">public class</span> <span class="cl">Persona</span>
{
    <span class="cm">// Aqu√≠ van atributos y m√©todos</span>
}`
  },
  { type:'question',
    text:'¬øPuedes describir con tus palabras qu√© es una clase?',
    replies:['Es un molde para crear objetos','No estoy seguro/a, ¬øpuedes repetir?','Es un tipo de variable']
  },
  { type:'bot',
    text:`¬°Muy bien! Una clase es efectivamente un molde. üëç<br><br>
    Ahora los <strong>Atributos</strong>: son las <strong>caracter√≠sticas o datos</strong> del objeto. Ejemplo:`,
    code:`<span class="kw">public class</span> <span class="cl">Persona</span>
{
    <span class="kw">public</span> <span class="nm">string</span> Nombre;
    <span class="kw">public</span> <span class="nm">int</span>    Edad;
    <span class="kw">public</span> <span class="nm">double</span> Estatura;
}`
  },
  { type:'bot',
    text:`Los <strong>Objetos</strong> üîµ son instancias concretas de una clase. Cada objeto tiene sus propios valores:`,
    code:`<span class="cm">// Crear un objeto de la clase Persona</span>
<span class="cl">Persona</span> <span class="nm">persona1</span> = <span class="kw">new</span> <span class="cl">Persona</span>();

<span class="nm">persona1</span>.Nombre   = <span class="st">"Ana"</span>;
<span class="nm">persona1</span>.Edad      = <span class="nm">21</span>;
<span class="nm">persona1</span>.Estatura  = <span class="nm">1.65</span>;`
  },
  { type:'question',
    text:'¬øCu√°l es la diferencia entre una clase y un objeto?',
    replies:['La clase es el molde; el objeto es la instancia','Son exactamente lo mismo','El objeto define la estructura']
  },
  { type:'bot',
    text:`¬°Correcto! üéâ Los <strong>M√©todos</strong> üîß definen las <strong>acciones</strong> del objeto:`,
    code:`<span class="kw">public class</span> <span class="cl">Persona</span>
{
    <span class="kw">public</span> <span class="nm">string</span> Nombre;
    <span class="kw">public</span> <span class="nm">int</span>    Edad;

    <span class="kw">public void</span> <span class="nm">Presentarse</span>()
    {
        Console.WriteLine(<span class="st">"Hola, me llamo "</span> + Nombre +
                          <span class="st">" y tengo "</span> + Edad + <span class="st">" a√±os."</span>);
    }
}`
  },
  { type:'bot',
    text:`Los m√©todos tambi√©n pueden <strong>retornar valores</strong>:`,
    code:`<span class="kw">public</span> <span class="nm">bool</span> <span class="nm">EsMayorDeEdad</span>()
{
    <span class="kw">return</span> Edad >= <span class="nm">18</span>;
}

<span class="kw">if</span> (<span class="nm">persona1</span>.EsMayorDeEdad())
    Console.WriteLine(<span class="st">"Es mayor de edad."</span>);`
  },
  { type:'bot',
    text:`Los <strong>Constructores</strong> üèóÔ∏è son m√©todos especiales que inicializan el objeto al crearlo.<br><br>
    ‚úÖ Reglas: mismo nombre que la clase ¬∑ sin tipo de retorno ¬∑ se invoca con <code>new</code>`,
    code:`<span class="kw">public class</span> <span class="cl">Persona</span>
{
    <span class="kw">public</span> <span class="nm">string</span> Nombre;
    <span class="kw">public</span> <span class="nm">int</span>    Edad;

    <span class="cm">// Constructor</span>
    <span class="kw">public</span> <span class="cl">Persona</span>(<span class="nm">string</span> nombre, <span class="nm">int</span> edad)
    {
        Nombre = nombre;
        Edad   = edad;
    }

    <span class="kw">public void</span> <span class="nm">Presentarse</span>()
    {
        Console.WriteLine(<span class="st">"Hola, soy "</span> + Nombre);
    }
}

<span class="cl">Persona</span> <span class="nm">p</span> = <span class="kw">new</span> <span class="cl">Persona</span>(<span class="st">"Carlos"</span>, <span class="nm">22</span>);
<span class="nm">p</span>.Presentarse(); <span class="cm">// ‚Üí Hola, soy Carlos</span>`
  },
  { type:'question',
    text:'¬øPara qu√© sirve el constructor en una clase?',
    replies:['Para inicializar los atributos al crear el objeto','Para declarar los m√©todos','Para definir el nombre de la clase']
  },
  { type:'bot',
    text:`¬°Excelente! Resumen del m√≥dulo:<br><br>
    üì¶ <strong>Clase:</strong> Molde que define estructura y comportamiento<br>
    üîµ <strong>Objeto:</strong> Instancia concreta de una clase<br>
    ‚öôÔ∏è <strong>Atributos:</strong> Datos o caracter√≠sticas del objeto<br>
    üîß <strong>M√©todos:</strong> Acciones del objeto<br>
    üèóÔ∏è <strong>Constructor:</strong> Inicializa el objeto al crearlo<br><br>
    ¬°Al <strong>Quiz</strong>! üß†`,
    replies:['¬°Listo para el quiz! üéÆ','Quiero repasar algo primero']
  }
];

function initChat() {
  APP.chatStep = 0;
  document.getElementById('chatMessages').innerHTML = '';
  processStep(0);
}

function processStep(idx) {
  if (idx >= CHAT_SCRIPT.length) return;
  const s = CHAT_SCRIPT[idx];
  showTyping(true);
  setTimeout(() => {
    showTyping(false);
    addBotMsg(s.text, s.code, s.replies);
    if (!s.replies) { APP.chatStep = idx+1; setTimeout(()=>processStep(APP.chatStep), 800); }
    else             { APP.chatStep = idx+1; }
  }, 900+Math.random()*400);
}

function addBotMsg(text, code, replies) {
  const msgs = document.getElementById('chatMessages');
  const w = document.createElement('div'); w.className = 'msg bot';
  const cHtml = code ? `<pre>${code}</pre>` : '';
  const rHtml = replies
    ? '<div class="quick-replies">'+
      replies.map(r=>`<button class="qr-btn" onclick="handleReply('${r.replace(/'/g,"\\'")}',this)">${r}</button>`).join('')+
      '</div>'
    : '';
  w.innerHTML=`<div class="msg-avatar">ü§ñ</div>
    <div class="msg-bubble">${typeof text==='function'?text():text}${cHtml}${rHtml}</div>`;
  msgs.appendChild(w);
  msgs.scrollTop = msgs.scrollHeight;
}

function addUserMsg(text) {
  const msgs = document.getElementById('chatMessages');
  const w = document.createElement('div'); w.className='msg user';
  w.innerHTML=`<div class="msg-avatar">üë§</div><div class="msg-bubble">${text}</div>`;
  msgs.appendChild(w); msgs.scrollTop=msgs.scrollHeight;
}

function showTyping(show) {
  let el = document.getElementById('typingInd');
  if (show && !el) {
    el=document.createElement('div'); el.id='typingInd'; el.className='typing-indicator';
    el.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    const m=document.getElementById('chatMessages'); m.appendChild(el); m.scrollTop=m.scrollHeight;
  } else if (!show && el) { el.remove(); }
}

function handleReply(text, btn) {
  btn.closest('.quick-replies').querySelectorAll('.qr-btn').forEach(b=>{b.disabled=true;b.style.opacity='.6'});
  btn.style.cssText+='background:var(--primary);color:#fff;opacity:1';
  addUserMsg(text);
  if (text.toLowerCase().includes('repasar')) {
    showTyping(true);
    setTimeout(()=>{showTyping(false);
      addBotMsg('¬øQu√© deseas repasar?',null,['Repasar Clases','Repasar Objetos','Repasar M√©todos','Al quiz üéÆ']);},600);
    return;
  }
  if (text==='Repasar Clases')  {APP.chatStep=1;setTimeout(()=>processStep(0),500);return;}
  if (text==='Repasar Objetos') {APP.chatStep=4;setTimeout(()=>processStep(3),500);return;}
  if (text==='Repasar M√©todos') {APP.chatStep=6;setTimeout(()=>processStep(5),500);return;}
  if (text.toLowerCase().includes('quiz')||APP.chatStep>=CHAT_SCRIPT.length) {setTimeout(()=>startQuiz(),600);return;}
  setTimeout(()=>processStep(APP.chatStep),600);
}

function sendMessage() {
  const inp=document.getElementById('chatInput'); const txt=inp.value.trim(); if(!txt)return;
  inp.value=''; addUserMsg(txt); showTyping(true);
  setTimeout(()=>{showTyping(false);addBotMsg('Gracias por tu mensaje üòä. Usa los botones o escribe "quiz" para continuar.',null,['Continuar lecci√≥n','Ir al quiz üéÆ']);},800);
}

/* =============================================================
   PANTALLA 3 ‚Äî QUIZ
   ============================================================= */
const QUIZ_Q = [
  {q:'¬øQu√© es una clase en POO?',
   o:['Un tipo de variable primitiva','Un molde que define la estructura de los objetos','Una funci√≥n del programa','Un archivo de configuraci√≥n'],
   c:1,fb:'‚úÖ Correcto. Una clase es un molde que define estructura y comportamiento.',
   fw:'‚ùå Incorrecto. Una clase es un molde o plantilla que define la estructura de los objetos.'},
  {q:'¬øCu√°l es un ejemplo de atributo en una clase "Autom√≥vil"?',
   o:['Arrancar()','Frenar()','Marca','Conducir()'],
   c:2,fb:'‚úÖ ¬°Exacto! "Marca" es una caracter√≠stica ‚Üí atributo.',
   fw:'‚ùå Los atributos son datos/caracter√≠sticas. "Marca" ser√≠a el atributo.'},
  {q:'¬øQu√© palabra clave se usa en C# para crear un objeto?',
   o:['create','object','new','instance'],
   c:2,fb:'‚úÖ Correcto. En C# se usa `new`.',
   fw:'‚ùå La palabra clave es `new`. Ej: Persona p = new Persona();'},
  {q:'¬øQu√© es un objeto en POO?',
   o:['Una copia exacta de la clase','Una instancia concreta creada a partir de una clase','El c√≥digo fuente','Un m√©todo sin par√°metros'],
   c:1,fb:'‚úÖ Un objeto es una instancia concreta de una clase.',
   fw:'‚ùå Un objeto es una instancia concreta creada a partir de una clase.'},
  {q:'¬øQu√© hace un m√©todo en una clase?',
   o:['Define los atributos','Declara el nombre','Define el comportamiento o acciones del objeto','Crea la base de datos'],
   c:2,fb:'‚úÖ Los m√©todos definen el comportamiento del objeto.',
   fw:'‚ùå Los m√©todos definen el comportamiento/acciones del objeto.'},
  {q:'¬øCaracter√≠stica principal de un constructor?',
   o:['Tiene tipo de retorno int','Se llama manualmente','Tiene el mismo nombre que la clase y se ejecuta al crear el objeto','Solo admite un par√°metro'],
   c:2,fb:'‚úÖ Mismo nombre que la clase, se ejecuta autom√°ticamente con `new`.',
   fw:'‚ùå El constructor: mismo nombre que la clase, sin tipo de retorno, se ejecuta autom√°ticamente.'},
  {q:'`Persona p = new Persona("Luis", 25);` ¬øQu√© hace esto en C#?',
   o:['Declara una clase','Crea un objeto p usando el constructor','Define un m√©todo est√°tico','Importa una librer√≠a'],
   c:1,fb:'‚úÖ Se crea el objeto `p` de tipo `Persona` usando su constructor.',
   fw:'‚ùå Se instancia un objeto `p` de la clase `Persona` con el constructor.'},
  {q:'¬øCu√°ntos objetos se pueden crear de una misma clase?',
   o:['Solo uno','Exactamente dos','Tantos como sean necesarios','Ninguno'],
   c:2,fb:'‚úÖ De una clase se crean tantos objetos como se necesite.',
   fw:'‚ùå De una clase se pueden crear tantos objetos como sean necesarios.'},
  {q:'Clase `C√≠rculo` tiene atributo `Radio` y m√©todo `CalcularArea()`. ¬øQu√© es `Radio`?',
   o:['Un m√©todo que calcula el radio','Una caracter√≠stica/dato del c√≠rculo','El constructor','El nombre de la clase base'],
   c:1,fb:'‚úÖ `Radio` es un atributo (dato/caracter√≠stica del objeto).',
   fw:'‚ùå `Radio` es un atributo. `CalcularArea()` es el m√©todo.'},
  {q:'Completa: "Un constructor tiene el _____ nombre que la clase y _____ tipo de retorno."',
   o:['diferente / tiene','mismo / no tiene','mismo / tiene void','diferente / no tiene'],
   c:1,fb:'‚úÖ Mismo nombre, sin tipo de retorno.',
   fw:'‚ùå El constructor tiene el MISMO nombre y NO tiene tipo de retorno.'}
];

function startQuiz() {
  APP.quizIndex=0; APP.quizScore=0; APP.quizAnswered=false;
  goTo('quiz'); renderQuizQ();
}

function renderQuizQ() {
  const q=QUIZ_Q[APP.quizIndex];
  document.getElementById('qNumLabel').textContent=`Pregunta ${APP.quizIndex+1}`;
  document.getElementById('qScoreLabel').textContent=APP.quizScore;
  const L=['A','B','C','D'];
  document.getElementById('quizBody').innerHTML=`
    <div class="question-number">PREGUNTA ${APP.quizIndex+1} DE ${QUIZ_Q.length}</div>
    <div class="question-text">${q.q}</div>
    <div class="quiz-options">
      ${q.o.map((o,i)=>`<button class="quiz-option" onclick="selectAnswer(${i})"><span class="option-letter">${L[i]}</span>${o}</button>`).join('')}
    </div>
    <div class="quiz-feedback" id="quizFeedback"></div>
    <div class="quiz-nav">
      <div class="score-badge">‚≠ê ${APP.quizScore} pts</div>
      <button class="btn-primary" id="nextBtn" style="display:none;width:auto;padding:10px 24px" onclick="nextQ()">
        ${APP.quizIndex<QUIZ_Q.length-1?'Siguiente ‚û§':'Ver resultados üèÜ'}
      </button>
    </div>`;
  APP.quizAnswered=false;
}

function selectAnswer(idx) {
  if (APP.quizAnswered) return; APP.quizAnswered=true;
  const q=QUIZ_Q[APP.quizIndex];
  const opts=document.querySelectorAll('.quiz-option');
  opts.forEach(o=>o.disabled=true);
  opts[idx].classList.add(idx===q.c?'correct':'incorrect');
  if (idx!==q.c) opts[q.c].classList.add('correct');
  if (idx===q.c) APP.quizScore+=10;
  const fb=document.getElementById('quizFeedback');
  fb.className=`quiz-feedback show ${idx===q.c?'correct-fb':'wrong-fb'}`;
  fb.innerHTML=`<span>${idx===q.c?q.fb:q.fw}</span>`;
  document.getElementById('qScoreLabel').textContent=APP.quizScore;
  document.getElementById('nextBtn').style.display='block';
}

function nextQ() {
  APP.quizIndex++;
  APP.quizIndex>=QUIZ_Q.length ? showQuizResult() : renderQuizQ();
}

function showQuizResult() {
  const pct=Math.round(APP.quizScore/(QUIZ_Q.length*10)*100);
  const msg=pct>=90?'üåü ¬°Excelente! Dominas los fundamentos de POO.':
            pct>=70?'üëç ¬°Muy bien! Tienes buena comprensi√≥n.':
            pct>=50?'üìö Aprobado. Repasa algunos conceptos.':
                    'üîÑ Necesitas repasar el material. ¬°T√∫ puedes!';
  localStorage.setItem('tutorpoo_quiz', JSON.stringify({score:APP.quizScore,pct}));
  document.getElementById('quizBody').innerHTML=`
    <div class="quiz-result">
      <div class="result-score-circle" style="--pct:${pct}%">
        <div class="result-score-inner">
          <div class="result-score-num">${APP.quizScore}</div>
          <div class="result-score-label">de 100 pts</div>
        </div>
      </div>
      <div class="result-title">${pct}% de aciertos</div>
      <div class="result-msg">${msg}</div>
      <button class="btn-primary" style="max-width:320px;margin:0 auto" onclick="startSurvey()">
        üìä Continuar a la encuesta BUS-11
      </button>
    </div>`;
}

/* =============================================================
   PANTALLA 4 ‚Äî ENCUESTA BUS-11
   ============================================================= */
const BUS11 = [
  'El chatbot fue f√°cil de usar.',
  'Pude encontrar la informaci√≥n que necesitaba con facilidad.',
  'El chatbot respondi√≥ de manera clara y comprensible.',
  'El contenido fue relevante para la materia.',
  'Estoy satisfecho/a con la experiencia de aprendizaje.',
  'El chatbot me ayud√≥ a comprender mejor los conceptos de POO.',
  'La navegaci√≥n e interacci√≥n fue intuitiva.',
  'El chatbot proporcion√≥ retroalimentaci√≥n √∫til ante mis respuestas.',
  'El dise√±o del chatbot es agradable visualmente.',
  'Recomendar√≠a este chatbot a otros estudiantes.',
  'En general, la calidad del chatbot como herramienta educativa es buena.'
];

function startSurvey() { goTo('survey'); renderSurvey(); }

function renderSurvey() {
  const body=document.getElementById('surveyBody'); body.innerHTML='';
  BUS11.forEach((q,i) => {
    const d=document.createElement('div'); d.className='survey-item';
    d.innerHTML=`<div class="survey-q"><strong>${i+1}.</strong> ${q}</div>
      <div class="likert-labels"><span>Totalmente en desacuerdo</span><span>Totalmente de acuerdo</span></div>
      <div class="likert-scale" id="lrow-${i}">
        ${[1,2,3,4,5].map(v=>`<button class="likert-btn" onclick="pickLikert(${i},${v},this)">${v}</button>`).join('')}
      </div>`;
    body.appendChild(d);
    if (i<BUS11.length-1) { const dv=document.createElement('div'); dv.className='divider'; body.appendChild(dv); }
  });
}

function pickLikert(qi,val,btn) {
  APP.surveyAnswers[qi]=val;
  document.getElementById('lrow-'+qi).querySelectorAll('.likert-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
}

function submitSurvey() {
  const missing=BUS11.some((_,i)=>APP.surveyAnswers[i]===undefined);
  if (missing) { document.getElementById('surveyError').style.display='block'; return; }
  document.getElementById('surveyError').style.display='none';
  const total=Object.values(APP.surveyAnswers).reduce((a,b)=>a+b,0);
  const avg=(total/BUS11.length).toFixed(2);
  localStorage.setItem('tutorpoo_survey', JSON.stringify({total,avg}));
  showFinalResults(total,avg);
}

/* =============================================================
   PANTALLA 5 ‚Äî RESULTADO FINAL
   ============================================================= */
function showFinalResults(busTotal,busAvg) {
  goTo('final');
  const qData  =JSON.parse(localStorage.getItem('tutorpoo_quiz')    ||'{"score":0,"pct":0}');
  const student=JSON.parse(localStorage.getItem('tutorpoo_student') ||'{}');
  const now=new Date();

  // ‚îÄ‚îÄ GUARDAR REGISTRO ACUMULATIVO ‚îÄ‚îÄ
  saveRecord({
    nombre:    student.nombre   || APP.student.nombre,
    control:   student.control  || APP.student.control,
    grupo:     student.grupo    || APP.student.grupo,
    quizScore: qData.score,
    quizPct:   qData.pct,
    busTotal:  busTotal,
    busAvg:    busAvg,
    fecha:     now.toLocaleDateString('es-MX',{year:'numeric',month:'2-digit',day:'2-digit'}),
    hora:      now.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'})
  });

  document.getElementById('finalSubtitle').innerHTML=
    `¬°Felicidades, <strong>${student.nombre}</strong>! Completaste el m√≥dulo de POO exitosamente.`;

  document.getElementById('finalCert').innerHTML=`
    Certifica que <strong>${student.nombre}</strong>
    (No. control: <strong>${student.control}</strong>, Grupo: <strong>${student.grupo}</strong>)
    complet√≥ el m√≥dulo <strong>"Introducci√≥n a Clases y M√©todos en POO"</strong>
    bajo la supervisi√≥n de la <strong>Dra. Mar√≠a Guadalupe Flores Lu√©vanos</strong>.<br>
    Fecha: ${now.toLocaleDateString('es-MX',{year:'numeric',month:'long',day:'numeric'})}`;

  const ul=busAvg>=4.5?'Excelente üåü':busAvg>=3.5?'Buena üëç':busAvg>=2.5?'Regular ‚ö†Ô∏è':'Baja üîÑ';
  document.getElementById('finalGrid').innerHTML=`
    <div class="final-stat">
      <div class="final-stat-num">${qData.score}<span style="font-size:1rem;color:var(--text-muted)">/100</span></div>
      <div class="final-stat-label">Puntaje Quiz</div>
    </div>
    <div class="final-stat">
      <div class="final-stat-num">${qData.pct}<span style="font-size:1rem;color:var(--text-muted)">%</span></div>
      <div class="final-stat-label">Porcentaje de aciertos</div>
    </div>
    <div class="final-stat">
      <div class="final-stat-num">${busTotal}<span style="font-size:1rem;color:var(--text-muted)">/55</span></div>
      <div class="final-stat-label">BUS-11 Total</div>
    </div>
    <div class="final-stat">
      <div class="final-stat-num">${busAvg}</div>
      <div class="final-stat-label">BUS-11 Prom. ¬∑ ${ul}</div>
    </div>`;
}

/* =============================================================
   ALMACENAMIENTO ACUMULATIVO EN localStorage
   ============================================================= */

/** Recupera todos los registros guardados */
function getRecords() {
  try { return JSON.parse(localStorage.getItem(RECORDS_KEY)||'[]'); }
  catch { return []; }
}

/** Agrega un registro nuevo al arreglo y lo persiste */
function saveRecord(r) {
  const list=getRecords();
  r.id=list.length+1;
  list.push(r);
  localStorage.setItem(RECORDS_KEY, JSON.stringify(list));
}

/* =============================================================
   PANEL DE AUTOR ‚Äî LOGIN
   ============================================================= */

/** Abre el modal de login del autor */
function openAdminLogin() {
  document.getElementById('adminPassInput').value='';
  document.getElementById('adminPassError').style.display='none';
  openModal('modal-login');
  setTimeout(()=>document.getElementById('adminPassInput').focus(),250);
}

/** Verifica la contrase√±a del autor */
function checkAdminPass() {
  if (document.getElementById('adminPassInput').value===AUTHOR_PASS) {
    closeModal('modal-login');
    openAdminPanel();
  } else {
    document.getElementById('adminPassError').style.display='block';
    document.getElementById('adminPassInput').value='';
    document.getElementById('adminPassInput').focus();
  }
}

function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

/* =============================================================
   PANEL DE AUTOR ‚Äî CONTENIDO
   ============================================================= */

function usabilityLabel(avg) {
  return Number(avg)>=4.5?'Excelente':Number(avg)>=3.5?'Buena':Number(avg)>=2.5?'Regular':'Baja';
}

/** Abre el panel de administrador cargando datos frescos */
function openAdminPanel() {
  const records=getRecords();
  renderStats(records);
  renderTable(records);
  openModal('modal-admin');
}

function renderStats(records) {
  const n=records.length;
  const avgQ=n?(records.reduce((s,r)=>s+Number(r.quizScore),0)/n).toFixed(1):'‚Äî';
  const avgB=n?(records.reduce((s,r)=>s+Number(r.busAvg),0)/n).toFixed(2):'‚Äî';
  document.getElementById('adminStats').innerHTML=`
    <div class="admin-stat">
      <div class="admin-stat-num">${n}</div>
      <div class="admin-stat-label">Alumnos registrados</div>
    </div>
    <div class="admin-stat">
      <div class="admin-stat-num">${avgQ}<span style="font-size:.85rem;color:var(--text-muted)">/100</span></div>
      <div class="admin-stat-label">Promedio Quiz (grupo)</div>
    </div>
    <div class="admin-stat">
      <div class="admin-stat-num">${avgB}<span style="font-size:.85rem;color:var(--text-muted)">/5</span></div>
      <div class="admin-stat-label">Promedio BUS-11 (grupo)</div>
    </div>`;
}

function renderTable(records) {
  const tbody=document.getElementById('adminTableBody');
  const empty=document.getElementById('adminEmpty');
  const table=document.getElementById('adminTable');
  if (!records.length) { table.style.display='none'; empty.style.display='block'; return; }
  table.style.display=''; empty.style.display='none';
  tbody.innerHTML=records.map(r=>`
    <tr>
      <td>${r.id}</td>
      <td>${r.nombre}</td>
      <td>${r.control}</td>
      <td>${r.grupo}</td>
      <td style="text-align:center;font-weight:700;color:var(--primary)">${r.quizScore}</td>
      <td style="text-align:center">${r.quizPct}%</td>
      <td style="text-align:center;font-weight:700">${r.busTotal}/55</td>
      <td style="text-align:center">${r.busAvg}</td>
      <td style="text-align:center">${usabilityLabel(r.busAvg)}</td>
      <td>${r.fecha}</td>
      <td>${r.hora}</td>
    </tr>`).join('');
}

/* =============================================================
   DESCARGA CSV
   ============================================================= */

/**
 * Genera y descarga un archivo CSV con todos los registros.
 * Incluye BOM UTF-8 para compatibilidad con Microsoft Excel.
 * Campos con comas o comillas se encierran en comillas dobles.
 */
function downloadCSV() {
  const records=getRecords();
  if (!records.length) { alert('No hay registros para descargar todav√≠a.'); return; }

  const esc=v=>`"${String(v).replace(/"/g,'""')}"`;
  const now=new Date();

  // Bloque de metadata del archivo
  const meta=
    esc('TutorPOO ‚Äî Chatbot Educativo de Programaci√≥n Orientada a Objetos')+'\n'+
    esc('Docente: Dra. Mar√≠a Guadalupe Flores Lu√©vanos')+'\n'+
    esc('M√≥dulo: Introducci√≥n a Clases y M√©todos en POO')+'\n'+
    esc('Descarga: '+now.toLocaleDateString('es-MX',{year:'numeric',month:'long',day:'numeric'}))+'\n\n';

  // Encabezados
  const headers=[
    'No.','Nombre completo','No. Control','Grupo',
    'Quiz Puntaje','Quiz Porcentaje',
    'BUS-11 Total (m√°x 55)','BUS-11 Promedio (m√°x 5)','Usabilidad',
    'Fecha','Hora'
  ].map(esc).join(',');

  // Filas
  const rows=records.map(r=>[
    r.id, esc(r.nombre), esc(r.control), esc(r.grupo),
    r.quizScore, r.quizPct+'%',
    r.busTotal, r.busAvg, esc(usabilityLabel(r.busAvg)),
    esc(r.fecha), esc(r.hora)
  ].join(','));

  // CSV final con BOM para Excel
  const csv='\uFEFF'+meta+headers+'\n'+rows.join('\n');

  // Crear enlace temporal y disparar descarga
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const fname=`TutorPOO_Resultados_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.csv`;
  const a=document.createElement('a');
  a.href=url; a.download=fname;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/** Borra todos los registros con confirmaci√≥n previa */
function clearAllRecords() {
  if (!confirm('‚ö†Ô∏è ¬øEliminar TODOS los registros almacenados?\nEsta acci√≥n no puede deshacerse.')) return;
  localStorage.removeItem(RECORDS_KEY);
  openAdminPanel();
}

/* =============================================================
   INICIALIZACI√ìN
   ============================================================= */
document.addEventListener('DOMContentLoaded',()=>{
  initProgressBar();
  // Cerrar modal al hacer clic en el overlay (fuera del contenido)
  document.getElementById('modal-login').addEventListener('click',function(e){ if(e.target===this) closeModal('modal-login'); });
  document.getElementById('modal-admin').addEventListener('click',function(e){ if(e.target===this) closeModal('modal-admin'); });
});
</script>
</body>
</html>
